
import asyncio
from itertools import product
import math
import random
import string


import pandas as pd
import numpy as np

from dataclasses import dataclass, field
from ddrmas_python.models.LLiteral import Sign
from ddrmas_python.models.QueryFocus import QueryFocus
from ddrmas_python.models.Rule import RuleType
from ddrmas_python.models.Agent import Agent
from ddrmas_python.models.LLiteral import LLiteral
from ddrmas_python.models.Literal import Literal
from ddrmas_python.models.Rule import Rule

from ddrmas_python.models.System import System
from ddrmas_python.services.load_system_from_file import load_system_from_file, load_system_from_yaml_str
from ddrmas_python.services.print_system import print_system

from ddrmas_python.utils.base_logger import logger

import signal
import traceback

from conftest import print_similarities



def agent_name_generator():
    
    cont = 1
    while True:
        for letter in string.ascii_lowercase:
            yield letter + str(cont)
        cont += 1


def literal_name_generator():

    cont = 1
    while True:
        for letter1, letter2 in product(string.ascii_lowercase, string.ascii_lowercase):
            yield letter1 + letter2 + str(cont) 
        cont += 1


def focus_name_generator():

    greek_letters = [
        'Alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta',
        'Iota', 'Kappa', 'Lambda', 'Mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho',
        'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'
    ]
    cont = 1
    while True:
        for letter in greek_letters:
             yield letter + str(cont)
        cont += 1



        


##TESTE:

def handler(signum, frame):
    print("Demorou demais!!")
    raise Exception("end of time")



async def perform_queries():
    
    results = []

    for k in range(11):

        system = load_system_from_file("travando1.yml")

        literals = system.vocabulary

        similarity_between_literals = {literal: {} for literal in 
                                       literals.union([lit.negated() for lit in literals])}
        
        
        pairs = [
            (Literal(True, "aa1", ["M"]), Literal(True, "ab1", ["M"])),
            (Literal(True, "aa1", ["M"]), Literal(True, "ae1", ["M"])),
            (Literal(True, "ae1", ["M"]), Literal(True, "ag1", ["M"])),
            (Literal(True, "ah1", ["M"]), Literal(True, "aj1", ["M"])),
        ]
        
        for literal1 in literals:
            literal1_neg = literal1.negated()
            similarity_between_literals[literal1][literal1] = 1
            similarity_between_literals[literal1_neg][literal1_neg] = 1
            similarity_between_literals[literal1][literal1_neg] = 0
            similarity_between_literals[literal1_neg][literal1] = 0

            for literal2 in literals:
                if literal1 == literal2: continue

                literal2_neg = literal2.negated()

                if (literal1, literal2) in pairs or (literal2, literal1) in pairs:
                    similarity_between_literals[literal1][literal2] = 1
                    similarity_between_literals[literal2][literal1] = 1
                    similarity_between_literals[literal1_neg][literal2_neg] = 1
                    similarity_between_literals[literal2_neg][literal1_neg] = 1

                else: 
                    similarity_between_literals[literal1][literal2] = 0
                    similarity_between_literals[literal2][literal1] = 0
                    similarity_between_literals[literal1_neg][literal2_neg] = 0
                    similarity_between_literals[literal2_neg][literal1_neg] = 0

                similarity_between_literals[literal1][literal2_neg] = 0
                similarity_between_literals[literal2_neg][literal1] = 0
                similarity_between_literals[literal2][literal1_neg] = 0
                similarity_between_literals[literal1_neg][literal2] = 0

        print_similarities(similarity_between_literals)

        system.sim_function = lambda a,b: similarity_between_literals[a.literal][b.literal]



        p = LLiteral(
                definer=system.agents["d1"], 
                literal=Literal(True, "ae1", ["M"])
                )
        
        """
        (D, ae1['M']) by D with focus rules: 
            (F, ~aa1['M']) <= 
            (F, ag1['M']) <= 
        """
        queryfocus = QueryFocus("alfa1", 
                                p,
                                emitter_agent=system.agents["d1"],
                                kb=[
                                     Rule("r_alfa1", LLiteral(Sign.FOCUS, Literal(False, "aa1", ["M"]))),
                                     Rule("r_alfa2", LLiteral(Sign.FOCUS, Literal(True, "ag1", ["M"]))),
                                ]
        )

        # signal.signal(signal.SIGALRM, handler)

        # signal.alarm(10)

        # tester = RandomDDRMASTester(
        #     agentsNumber=20, 
        #     literalsNumber=100, 
        #     rulesNumber=300, 
        #     sslPercentage=0.8, 
        #     cyclePercentage=0,
        #     similarityPercentage=0.1

                
        print("\n\n\n--------query\n\n")

        ans = None
        try:
            ans = await system.agents["d1"].query(p, queryfocus, [])
        except Exception as exc:
            traceback.print_exc()
            logger.error(exc)


        print(ans)

       


asyncio.run(perform_queries())

    
